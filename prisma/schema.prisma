generator client {
  provider = "prisma-client"
  output   = "../generated"
}

datasource db {
  provider = "postgresql"
}

model Alert {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  type      AlertType
  config    Json     // e.g., { "threshold": 10000, "wallet": "0x..." }

  createdAt DateTime @default(now())

  @@map("alerts")
}

model Trade {
  id            String   @id @default(cuid())
  assetId       String
  side          String   // "BUY" or "SELL"
  size          Float
  price         Float
  tradeValue    Float    // size * price
  timestamp     DateTime

  walletAddress String   @default("")
  walletProfile WalletProfile? @relation(fields: [walletAddress], references: [id])

  // Intelligence flags
  isWhale       Boolean  @default(false)
  isSmartMoney  Boolean  @default(false)
  isFresh       Boolean  @default(false)
  isSweeper     Boolean  @default(false)

  // Market context
  conditionId   String?
  outcome       String?
  question      String?
  image         String?
  marketCategory    String?
  marketType        String?
  formatType        String?
  feeBps            Float?
  denominationToken String?
  liquidity         Float?
  volume24h         Float?
  openTime          DateTime?
  closeTime         DateTime?
  resolutionTime    DateTime?
  resolutionSource  String?
  eventId           String?
  eventTitle        String?
  eventSlug         String?
  eventStart        DateTime?
  eventEnd          DateTime?
  tags              String[]
  sport             String?
  league            String?
  marketGroup       String?
  marketDepthBucket String?
  timeToCloseBucket String?
  holderTop5Share   Float?
  holderTop10Share  Float?
  holderCount       Int?
  smartHolderCount  Int?

  // Enrichment fields for wallet identity matching
  transactionHash  String?  // For Data-API matching
  blockNumber      BigInt?  // For tx log fallback matching
  logIndex         Int?     // Unique identifier within block
  enrichmentStatus String?  @default("pending") // "pending" | "enriched" | "failed"

  @@index([walletAddress])
  @@index([timestamp])
  @@index([isWhale, timestamp])
  @@index([transactionHash])
  @@index([enrichmentStatus, timestamp])
  @@index([eventId])
  @@index([marketCategory])
  @@index([closeTime])
  @@index([sport, league])
  @@map("trades")
}

model UserAlertSettings {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])

  // Channels
  discordWebhook String?
  smsNumber      String?
  telegramId     String?

  // Subscriptions
  wallets        String[] // Array of wallet addresses to watch
  markets        String[] // Array of market IDs to watch
  alertTypes     AlertType[] // Types of alerts to receive

  updatedAt      DateTime @updatedAt

  @@map("user_alert_settings")
}

model User {
  id            String   @id // Privy DID (e.g., "did:privy:...")
  email         String?  @unique
  walletAddress String?  @unique // Primary connected wallet
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Premium/Subscription status
  tier          SubscriptionTier @default(FREE)
  stripeCustomerId String?

  // User preferences
  watchlist     Watchlist[]
  alerts        Alert[] // Old alert model, keeping for now
  alertSettings UserAlertSettings?

  @@map("users")
}

model WalletPortfolioSnapshot {
  id            String        @id @default(cuid())
  walletAddress String
  wallet        WalletProfile @relation(fields: [walletAddress], references: [id])
  timestamp     DateTime      @default(now())

  // Summary metrics
  totalValue    Float         @default(0)
  totalPnl      Float         @default(0)

  // Raw data
  positions     Json          // Array of positions from Gamma

  @@index([walletAddress])
  @@index([timestamp])
  @@map("wallet_portfolio_snapshots")
}

model WalletProfile {
  id          String   @id // wallet address
  label       String?  // e.g., "Smart Whale", "Degen"
  totalPnl    Float    @default(0) // Total PnL in USD
  winRate     Float    @default(0) // Win rate as decimal (0.0 to 1.0)
  isFresh     Boolean  @default(false) // < 10 transactions
  txCount     Int      @default(0)
  maxTradeValue Float  @default(0)
  activityLevel String? // "LOW", "MEDIUM", "HIGH"
  lastUpdated DateTime @default(now())
  trades      Trade[]
  snapshots   WalletPortfolioSnapshot[]

  @@map("wallet_profiles")
}

model Watchlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  // What they are watching
  walletAddress String? // Watching a specific whale
  marketId      String? // Watching a specific market

  createdAt DateTime @default(now())

  @@unique([userId, walletAddress])
  @@unique([userId, marketId])
  @@map("watchlists")
}

enum AlertType {
  WHALE_MOVEMENT
  MARKET_SPIKE
  SMART_MONEY_ENTRY
}

enum SubscriptionTier {
  FREE
  PRO
  WHALE
}

model WalletLeaderboardSnapshot {
  id            String   @id @default(uuid())
  walletAddress String
  period        String   // "Daily" | "Weekly" | "Monthly" | "All Time"
  rank          Int
  totalPnl      Float
  totalVolume   Float
  winRate       Float
  snapshotAt    DateTime
  accountName   String?

  @@index([walletAddress])
  @@index([snapshotAt])
  @@map("wallet_leaderboard_snapshots")
}

model WhalePositionSnapshot {
  id                  String   @id @default(cuid())
  snapshotAt          DateTime @map("snapshot_ts")
  timeframe           String
  walletRank          Int      @map("wallet_rank")
  positionRank        Int      @map("position_rank")
  proxyWallet         String   @map("proxy_wallet")
  conditionId         String   @map("condition_id")
  assetId             String   @map("asset_id")
  eventId             String?  @map("event_id")
  eventSlug           String?  @map("event_slug")
  marketTitle         String?  @map("market_title")
  marketSlug          String?  @map("market_slug")
  iconUrl             String?  @map("icon_url")
  outcome             String?
  outcomeIndex        Int?     @map("outcome_index")
  oppositeOutcome     String?  @map("opposite_outcome")
  oppositeAssetId     String?  @map("opposite_asset_id")
  endDate             DateTime? @map("end_date")
  negativeRisk        Boolean? @map("negative_risk")
  redeemable          Boolean?
  size                Float
  avgPrice            Float    @map("avg_price")
  curPrice            Float    @map("cur_price")
  initialValue        Float    @map("initial_value")
  currentValue        Float    @map("current_value")
  totalBought         Float    @map("total_bought")
  cashPnl             Float    @map("cash_pnl")
  percentPnl          Float    @map("percent_pnl")
  realizedPnl         Float    @map("realized_pnl")
  percentRealizedPnl  Float?   @map("percent_realized_pnl")

  @@unique([snapshotAt, timeframe, proxyWallet, assetId])
  @@index([proxyWallet])
  @@index([snapshotAt])
  @@map("whale_position_snapshots")
}

model AiInsightHistory {
  id                   String   @id @default(cuid())

  // Pick identifier (composite key)
  conditionId          String
  outcome              String
  eventTitle           String?

  // Snapshot metadata
  snapshotAt           DateTime @default(now())

  // Core metrics
  confidence           Int
  confidencePercentile Float

  // Volume & activity
  totalVolume          Float
  topTraderVolume      Float
  topTraderCount       Int

  // Market state
  latestPrice          Float
  isResolved           Boolean  @default(false)

  // Enhanced metrics
  volumeZScore         Float?
  hhiConcentration     Float?
  rankWeightedScore    Float?
  directionConviction  Float?
  isUnusualActivity    Boolean  @default(false)
  isConcentrated       Boolean  @default(false)

  @@unique([conditionId, outcome, snapshotAt])
  @@index([conditionId, outcome, snapshotAt])
  @@index([snapshotAt])
  @@map("ai_insight_history")
}

model BiggestWinner {
  id            String   @id @default(cuid())
  winRank       Int
  proxyWallet   String
  userName      String?
  eventSlug     String?
  eventTitle    String?
  initialValue  Float
  finalValue    Float
  pnl           Float
  profileImage  String?
  timePeriod    String   @default("day")
  snapshotAt    DateTime @default(now())

  @@index([snapshotAt, timePeriod])
  @@index([winRank])
  @@map("biggest_winners")
}
